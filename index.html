<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VORTEX WEB</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg: #18181b;
            --panel: #27272a;
            --text: #f4f4f5;
            --subtext: #a1a1aa;
            --accent: #fafafa;
            --accent-hover: #d4d4d8;
            --border: #3f3f46;
            --danger: #f87171;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Helvetica', 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 10;
            width: 400px;
            background: rgba(39, 39, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 28px; margin: 10px 0 5px; font-weight: bold; letter-spacing: 2px; }
        p.sub { color: var(--subtext); font-size: 11px; margin-bottom: 20px; }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            text-transform: uppercase;
            margin: 5px;
            width: 100%;
            max-width: 200px;
        }
        .btn:hover { background: var(--accent-hover); transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--subtext);
            color: var(--subtext);
        }
        .btn-outline:hover { background: var(--border); color: var(--text); }

        .btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        .btn-danger:hover { background: rgba(248, 113, 113, 0.1); }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group {
            background: var(--panel);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-group label { font-size: 9px; font-weight: bold; color: var(--subtext); margin-left: 5px;}
        .input-group input {
            background: transparent;
            border: none;
            color: white;
            text-align: right;
            width: 60px;
            font-size: 14px;
            font-family: inherit;
        }
        .input-group input:focus { outline: none; }

        .ef-rating { font-size: 64px; font-weight: bold; margin: 10px 0; }
        
        .bar-container {
            margin-bottom: 15px;
            text-align: left;
        }
        .bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: bold;
            color: var(--subtext);
            margin-bottom: 4px;
        }
        .bar-bg {
            background: #313244;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            width: 0%;
            transition: width 1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        .hidden { display: none; }
        
        #paste-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            color: var(--subtext);
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        #paste-area:hover { border-color: var(--accent); color: var(--text); }
        #paste-area.highlight { background: rgba(255,255,255,0.05); border-color: var(--accent); }

        .loader {
            width: 20px; height: 20px;
            border: 3px solid var(--subtext);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div class="container" id="app-container">
        
        <div id="step-landing">
            <div class="header-row">
                <span style="font-weight:bold; font-size:10px; color:var(--subtext)">VORTEX WEB</span>
            </div>
            <h1>VORTEX</h1>
            <p class="sub">Ur not cooking with this 3/1 bro ðŸ¥€ðŸ¥€ðŸ¥€</p>

            <div id="paste-area" onclick="document.getElementById('file-input').click()">
                <span id="paste-text">Upload image of thermos (file OR ctrl+v)</span>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <button class="btn btn-outline" onclick="App.goToManual()">Manual Entry</button>
        </div>

        <div id="step-loading" class="hidden">
            <h1>PROCESSING</h1>
            <p class="sub">Extracting data via Tesseract OCR...</p>
            <div class="loader"></div>
        </div>

        <div id="step-verify" class="hidden">
            <div class="header-row" style="margin-bottom:20px;">
                <span style="font-weight:bold; font-size:14px;">VERIFY</span>
                <button class="btn-danger" style="padding: 5px 10px; font-size:10px; width:auto; border-radius:10px;" onclick="App.reportBug()">Flag Error</button>
            </div>

            <div class="grid" id="input-grid"></div>

            <button class="btn" onclick="App.calculate()">CALCULATE</button>
        </div>

        <div id="step-results" class="hidden">
            <div class="header-row">
                <span style="font-weight:bold; font-size:10px; color:var(--subtext)">INTENSITY</span>
                <div>
                    <button id="btn-report-res" class="btn-danger" style="padding: 4px 8px; font-size:9px; width:auto; border-radius:8px; margin-right:5px;" onclick="App.reportBug(true)">Report</button>
                    <button class="btn-outline" style="padding: 4px 8px; font-size:9px; width:auto; border-radius:8px;" onclick="App.reset()">Reset</button>
                </div>
            </div>
            
            <div class="ef-rating" id="res-ef">EF0</div>
            <div id="res-bars"></div>
        </div>

    </div>

<script>
const App = {
    config: {
        reportUrl: "https://vortex-proxy.nixxzo304.workers.dev/"
    },
    state: {
        extractedData: {},
        lastResults: null,
        imageBlob: null,
        animating: true
    },
    
    fields: [
        { label: "TEMP", key: "temp" }, { label: "DEW", key: "dew" },
        { label: "CAPE", key: "cape" }, { label: "3CAPE", key: "3cape" },
        { label: "SRH", key: "srh" }, { label: "LAPSE", key: "lapse" },
        { label: "SFC RH", key: "rh" }, { label: "MID RH", key: "mid_rh" },
        { label: "PWAT", key: "pwat" }, { label: "SPEED", key: "speed", placeholder: "60" }
    ],

    init() {
        this.setupEventListeners();
        this.initAnimation();
    },

    setupEventListeners() {
        document.addEventListener('paste', this.handlePaste.bind(this));
        document.getElementById('file-input').addEventListener('change', (e) => {
            if(e.target.files.length > 0) this.processImage(e.target.files[0]);
        });
        document.addEventListener('visibilitychange', () => {
            this.state.animating = !document.hidden;
            if(this.state.animating) this.animate();
        });
    },

    switchStep(id) {
        ['step-landing', 'step-loading', 'step-verify', 'step-results'].forEach(s => 
            document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    },

    handlePaste(e) {
        if(document.getElementById('step-landing').classList.contains('hidden')) return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf("image") === 0) {
                this.processImage(item.getAsFile());
                return;
            }
        }
    },

    async processImage(blob) {
        this.state.imageBlob = blob;
        this.switchStep('step-loading');
        try {
            const { data: { text } } = await Tesseract.recognize(blob, 'eng');
            this.parseData(text);
            this.buildVerifyUI();
            this.switchStep('step-verify');
        } catch (err) {
            alert("OCR Failed. Try manual entry.");
            this.switchStep('step-landing');
        }
    },

    goToManual() {
        this.state.extractedData = {};
        this.buildVerifyUI();
        this.switchStep('step-verify');
    },

    parseData(text) {
        const replacements = { 'Q': '0', 'O': '0', 'o': '0', '@': '0', 'Ã˜': '0', 'D': '0', 'theta': '0' };
        text = text.replace(/[QOo@Ã˜D]|theta/g, m => replacements[m]);

        const find = (patterns) => {
            for (let p of patterns) {
                const regex = new RegExp(p + ".*?(\\d[\\d\\.]*)", "i");
                const match = text.match(regex);
                if (match && match[1]) return match[1].replace(/\.$/, "");
            }
            return "";
        };

        let rawPwat = find(["PWAT", "PHAT"]);
        if (rawPwat.startsWith("17.")) rawPwat = "1." + rawPwat.substring(3);
        if (/^7\.\d+$/.test(rawPwat)) rawPwat = "1" + rawPwat.substring(1);

        this.state.extractedData = {
            temp: find(["TEMPERATURE", "TEMP"]),
            dew: find(["DEW\\s*P[O0Q@Ã˜oD]INT", "P[O0Q@Ã˜oD]INT", "DEWPOINT", "DEW"]),
            "3cape": find(["3\\s*CAPE", "3CAPE"]),
            cape: find(["(?<!3)CAPE"]),
            lapse: find(["0-3\\s*[Kk]?[Mm]?\s*LAPSE", "0-3\\s*LAPSE", "0-3"]),
            srh: find(["SRH"]),
            rh: find(["SURFACE\\s*RH", "SFC\\s*RH"]),
            mid_rh: find(["MB\\s*RH", "500\\s*MB", "MID\\s*RH"]),
            pwat: rawPwat,
            speed: find(["MOTION", "SPEED", "MOVING"]),
            raw: text
        };
    },

    buildVerifyUI() {
        const grid = document.getElementById('input-grid');
        grid.innerHTML = '';
        this.fields.forEach(f => {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `<label>${f.label}</label><input id="inp-${f.key}" placeholder="${f.placeholder || ''}" value="${this.state.extractedData[f.key] || ''}">`;
            grid.appendChild(div);
        });
    },

calculate() {
        let v = {};
        this.fields.forEach(f => { const val = document.getElementById('inp-' + f.key).value.replace(',', '.').replace(/[^0-9.]/g, ""); v[f.key] = parseFloat(val) || 0.0; });
        if(!v.speed) v.speed = 60.0;
        
        const norm = (val, mn, mx) => val <= mn ? 0 : val >= mx ? 1 : (val - mn) / (mx - mn);
        
        let energy_raw = norm(v.cape, 500, 5000) * 80 + norm(v["3cape"], 50, 300) * 20;
        let shear_raw = norm(v.srh, 100, 800) * 85 + norm(v.speed, 30, 90) * 15;
        let spread = v.temp - v.dew;
        let moisture_raw = ((1.0 - norm(spread, 0, 20)) * 40) + (norm(v.rh, 40, 100) * 40) + (norm(v.mid_rh, 30, 90) * 20);
        let moisture_wedge_factor = Math.pow(moisture_raw / 100, 2) * 100;
        
        let lapse_up = norm(v.lapse, 6.0, 7.5);
        let lapse_down = 1.0 - norm(v.lapse, 8.8, 10.5); 
        let lapse_score = lapse_up * lapse_down * 100;
        let lapse_plateau = norm(v.lapse, 7.5, 8.8); 
        if (lapse_plateau > 0 && lapse_plateau < 1) lapse_score = 100; 
        
        let power_index = (energy_raw * 0.6) + (shear_raw * 0.4);
        let sh = { "Wedge": 0, "Stovepipe": 0, "Drillbit/Tiny Funnel": 0, "Sidewinder": 0, "Cone": 0, "Rope": 0 };
        
        let low_tier_mix = 1.0 - norm(power_index, 25, 55);
        let mid_tier_mix = norm(power_index, 25, 55) * (1.0 - norm(power_index, 60, 80));
        let high_tier_mix = norm(power_index, 60, 90);

        sh["Cone"] += low_tier_mix * 40 + mid_tier_mix * 60;
        sh["Rope"] += low_tier_mix * 50;
        sh["Drillbit/Tiny Funnel"] += low_tier_mix * 20;

        sh["Stovepipe"] += mid_tier_mix * 30 + high_tier_mix * 30;
        sh["Wedge"] += high_tier_mix * 15;

        let raw_energy_boost = norm(v.cape, 5000, 12000) * 35; 
        sh["Wedge"] += raw_energy_boost;
        
        sh["Wedge"] += (moisture_wedge_factor / 100.0) * high_tier_mix * 70; 
        sh["Stovepipe"] += (moisture_raw / 100.0) * high_tier_mix * 40;
        
        let constriction_force = norm(power_index, 60, 75) * (1.0 - norm(moisture_raw, 65, 75));
        sh["Stovepipe"] += constriction_force * 25;
        sh["Cone"] *= (1.0 - (constriction_force * 0.5));

        let high_lapse_factor = norm(v.lapse, 8.2, 9.5);
        let wedge_penalty = sh["Wedge"] * high_lapse_factor * 0.8;
        
        let nuclear_factor = norm(v.cape, 7500, 9000);
        
        wedge_penalty *= (1.0 - nuclear_factor); 
        sh["Wedge"] += nuclear_factor * 80;
        sh["Stovepipe"] += nuclear_factor * 80;
        sh["Cone"] *= (1.0 - nuclear_factor); 
        sh["Sidewinder"] *= (1.0 - (nuclear_factor * 0.5));

        sh["Wedge"] -= wedge_penalty; 
        sh["Stovepipe"] += wedge_penalty * 0.7; 
        sh["Drillbit/Tiny Funnel"] += wedge_penalty * 0.5;
        
        let soup_factor = norm(moisture_raw, 75, 95) * (1.0 - norm(v.lapse, 7.0, 7.8)); 
        sh["Sidewinder"] += soup_factor * 45; 
        sh["Wedge"] -= soup_factor * 20;
        
        sh["Sidewinder"] += norm(v.speed, 55, 80) * 40;
        
        let chaos_factor = norm(v.lapse, 8.5, 9.2) * norm(v.speed, 65, 75);
        sh["Sidewinder"] += chaos_factor * 50;
        sh["Stovepipe"] -= chaos_factor * 30;

        let dry_factor = 1.0 - (moisture_raw / 100.0); 
        let weak_storm_factor = 1.0 - norm(power_index, 35, 50);
        sh["Drillbit/Tiny Funnel"] += (high_lapse_factor * dry_factor * weak_storm_factor) * 80;

        let shear_rescue = norm(v.srh, 650, 750) * norm(moisture_raw, 75, 85) * (1.0 - norm(v.lapse, 5.8, 6.5));
        sh["Wedge"] += shear_rescue * 50;
        sh["Stovepipe"] += shear_rescue * 20;

        let power_lapse_boost = norm(power_index, 75, 85) * norm(v.lapse, 8.4, 9.0);
        sh["Wedge"] += power_lapse_boost * 20;

        let speed_kill = norm(v.speed, 70, 85);
        let wedge_dominance = norm(sh["Wedge"], 40, 60);
        sh["Sidewinder"] += speed_kill * wedge_dominance * 40;
        sh["Sidewinder"] += speed_kill * 20;

        let shape_suppress = norm(Math.max(sh["Wedge"], sh["Stovepipe"]), 30, 50);
        sh["Cone"] *= (1.0 - (shape_suppress * 0.8));
        sh["Cone"] *= (1.0 - norm(v.cape, 4000, 5000) * 0.9);

        let shear_safety = norm(v.srh, 100, 350);
        let shear_penalty_mult = 0.25 + (0.75 * shear_safety);
        let shear_fail_add = 1.0 - shear_safety;

        sh["Wedge"] *= shear_penalty_mult;
        sh["Stovepipe"] *= (0.4 + (0.6 * shear_safety));
        sh["Sidewinder"] *= (0.5 + (0.5 * shear_safety)); 
        
        sh["Cone"] += shear_fail_add * 60;
        sh["Rope"] += shear_fail_add * 40;
        sh["Drillbit/Tiny Funnel"] += shear_fail_add * 25;

        sh["Drillbit/Tiny Funnel"] += sh["Rope"] * 0.3;

        Object.keys(sh).forEach(k => { if(sh[k] < 0) sh[k] = 0; });
        
        let mv = Math.min(95, 5 + norm(v.srh, 200, 800) * 80);
        let rain = Math.min(100, 10 + norm(v.pwat, 1.0, 2.5) * 70 + norm(v.rh, 60, 100) * 20);
        
        let ef_raw = ((v.cape * v.srh) / 150000 + (norm(v.lapse, 7.0, 10.0) * 2.0));
        let ef_score = ef_raw * (0.5 + (0.5 * shear_safety));

        let ef = "EF0"; 
        if (ef_score > 1.5) ef = "EF1"; 
        if (ef_score > 3.0) ef = "EF2"; 
        if (ef_score > 5.0) ef = "EF3"; 
        if (ef_score > 8.0) ef = "EF4"; 
        if (ef_score > 13.0) ef = "EF5";
        
        let est_wind = 65 + (ef_score * 11); 
        if (est_wind > 320) est_wind = 320;
        
        let dominant_shape = Object.keys(sh).reduce((a, b) => sh[a] > sh[b] ? a : b);
        let base_width = power_index * 12;
        let width_mult = 1.0;
        
        if (dominant_shape == "Wedge") width_mult = 2.2; 
        else if (dominant_shape == "Sidewinder") width_mult = 1.4; 
        else if (dominant_shape == "Stovepipe") width_mult = 1.0; 
        else if (dominant_shape == "Cone") width_mult = 0.5; 
        else if (dominant_shape == "Rope") width_mult = 0.2; 
        else if (dominant_shape.includes("Drillbit")) width_mult = 0.4;
        
        let est_width = base_width * width_mult; 
        if (est_width < 50) est_width = 50; 
        let width_miles = est_width / 1760.0;
        
        this.state.lastResults = { inputs: v, ef: ef, wind: Math.floor(est_wind), width: width_miles.toFixed(2), shape_scores: sh };
        this.showResults(sh, mv, rain, ef, est_wind, width_miles);
    },

    showResults(sh, mv, rain, ef, wind, width) {
        this.switchStep('step-results');
        document.getElementById('res-ef').innerText = ef;

        const colors = { "Wedge":"#f38ba8", "Stovepipe":"#89b4fa", "Drillbit/Tiny Funnel":"#94e2d5", "Sidewinder":"#a6e3a1", "Cone":"#cba6f7", "Rope":"#6c7086" };
        let total = Object.values(sh).reduce((a,b)=>a+b, 0);
        let sorted = Object.entries(sh).sort((a,b)=>b[1]-a[1]);
        
        let html = '';
        sorted.forEach(([key, val]) => {
            let pct = (val / total) * 100;
            html += `<div class="bar-container"><div class="bar-header"><span>${key.toUpperCase()}</span><span>${pct.toFixed(1)}%</span></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${colors[key]||'white'};"></div></div></div>`;
        });

        [ ["MULTI-VORTEX", mv, "#fab387"], ["RAIN WRAPPED", rain, "#f9e2af"] ].forEach(([name, val, col]) => {
            html += `
            <div class="bar-container" style="margin-top:20px;">
                <div class="bar-header">
                    <span>${name}</span>
                    <span>${val.toFixed(1)}%</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width:${val}%; background:${col};"></div>
                </div>
            </div>`;
        });

        document.getElementById('res-bars').innerHTML = html;
    },

    reset() {
        this.state.extractedData = {};
        this.state.lastResults = null;
        this.switchStep('step-landing');
        document.getElementById('file-input').value = '';
    },

    reportBug(useLastResults=false) {
        if (this.config.reportUrl.includes("INSERT_YOUR")) {
            alert("Please configure the Cloudflare Worker URL.");
            return;
        }
        const user = prompt("Discord Username:");
        if (!user) return;
        const msg = prompt("Describe the issue:");
        if (!msg) return;

        document.getElementById('btn-report-res').innerText = "Sending...";

        const payload = {
            embeds: [{
                title: "VORTEX WEB Bug Report",
                description: `**Reporter:** \`${user}\`\n**Feedback:** ${msg}\n\n` + (this.state.lastResults ? `**Data:**\n\`\`\`json\n${JSON.stringify(this.state.lastResults, null, 2)}\n\`\`\`` : `**Raw:**\n\`\`\`\n${this.state.extractedData.raw || "Manual"}\n\`\`\``),
                color: 16777215
            }]
        };

        const fd = new FormData();
        fd.append('payload_json', JSON.stringify(payload));
        if (this.state.imageBlob) fd.append('file', this.state.imageBlob, 'thermo.png');

        fetch(this.config.reportUrl, { method: 'POST', body: fd })
            .then(r => { alert(r.ok ? "Report Sent!" : "Failed."); document.getElementById('btn-report-res').innerText = "Report"; })
            .catch(e => { alert("Error: " + e); document.getElementById('btn-report-res').innerText = "Report"; });
    },

    initAnimation() {
        const c = document.getElementById('bg-canvas'), ctx = c.getContext('2d');
        let w, h, stars = [], mouse = {x:-100, y:-100};
        
        const resize = () => { w = c.width = window.innerWidth; h = c.height = window.innerHeight; };
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        resize();

        for(let i=0; i<150; i++) stars.push({ x:Math.random()*w, y:Math.random()*h, size:Math.random()*2, a:Math.random(), s:(Math.random()*0.005+0.001)*(Math.random()>.5?1:-1) });

        const loop = () => {
            if(!this.state.animating) { requestAnimationFrame(loop); return; }
            ctx.fillStyle = '#18181b'; ctx.fillRect(0,0,w,h);
            const g = ctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, 150);
            g.addColorStop(0, 'rgba(63,63,70,0.3)'); g.addColorStop(1, 'rgba(24,24,27,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
            
            stars.forEach(s => {
                s.a += s.s; if(s.a>=1 || s.a<=0.2) s.s *= -1;
                ctx.fillStyle = `rgba(255,255,255,${s.a})`;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(loop);
        };
        loop();
    }
};

App.init();
</script>
</body>
</html>
