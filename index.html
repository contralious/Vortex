<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VORTEX WEB</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg: #18181b;
            --panel: #27272a;
            --text: #f4f4f5;
            --subtext: #a1a1aa;
            --accent: #fafafa;
            --accent-hover: #d4d4d8;
            --border: #3f3f46;
            --danger: #f87171;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Helvetica', 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 10;
            width: 400px;
            background: rgba(39, 39, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 28px; margin: 10px 0 5px; font-weight: bold; letter-spacing: 2px; }
        p.sub { color: var(--subtext); font-size: 11px; margin-bottom: 20px; }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            text-transform: uppercase;
            margin: 5px;
            width: 100%;
            max-width: 200px;
        }
        .btn:hover { background: var(--accent-hover); transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--subtext);
            color: var(--subtext);
        }
        .btn-outline:hover { background: var(--border); color: var(--text); }

        .btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        .btn-danger:hover { background: rgba(248, 113, 113, 0.1); }


        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group {
            background: var(--panel);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-group label { font-size: 9px; font-weight: bold; color: var(--subtext); margin-left: 5px;}
        .input-group input {
            background: transparent;
            border: none;
            color: white;
            text-align: right;
            width: 60px;
            font-size: 14px;
            font-family: inherit;
        }
        .input-group input:focus { outline: none; }


        .ef-rating { font-size: 64px; font-weight: bold; margin: 10px 0; }
        
        .bar-container {
            margin-bottom: 15px;
            text-align: left;
        }
        .bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: bold;
            color: var(--subtext);
            margin-bottom: 4px;
        }
        .bar-bg {
            background: #313244;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            width: 0%;
            transition: width 1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        .hidden { display: none; }
        
        #paste-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            color: var(--subtext);
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        #paste-area:hover { border-color: var(--accent); color: var(--text); }
        #paste-area.highlight { background: rgba(255,255,255,0.05); border-color: var(--accent); }

        .loader {
            width: 20px; height: 20px;
            border: 3px solid var(--subtext);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div class="container" id="app-container">
        
        <div id="step-landing">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:10px; color:var(--subtext)">VORTEX </span>
            </div>
            <h1>VORTEX</h1>
            <p class="sub">You're not cooking with this 3/1 bro ðŸ¥€ðŸ¥€ðŸ¥€</p>

            <div id="paste-area" onclick="document.getElementById('file-input').click()">
                <span id="paste-text">Click to Upload or Paste Image of thermodynamics</span>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <button class="btn btn-outline" onclick="goToManual()">Manual Entry</button>
        </div>


        <div id="step-loading" class="hidden">
            <h1>PROCESSING</h1>
            <p class="sub">Extracting data via Tesseract OCR...</p>
            <div class="loader"></div>
        </div>


        <div id="step-verify" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span style="font-weight:bold; font-size:14px;">VERIFY</span>
                <button class="btn-danger" style="padding: 5px 10px; font-size:10px; width:auto; border-radius:10px;" onclick="reportBug()">Flag Error</button>
            </div>

            <div class="grid" id="input-grid">

            </div>

            <button class="btn" onclick="calculate()">CALCULATE</button>
        </div>

        <div id="step-results" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size:10px; color:var(--subtext)">INTENSITY</span>
                <div>
                    <button class="btn-danger" style="padding: 4px 8px; font-size:9px; width:auto; border-radius:8px; margin-right:5px;" onclick="reportBug(true)">Report</button>
                    <button class="btn-outline" style="padding: 4px 8px; font-size:9px; width:auto; border-radius:8px;" onclick="resetApp()">Reset</button>
                </div>
            </div>
            
            <div class="ef-rating" id="res-ef">EF0</div>
            
            <div id="res-bars"></div>

            <div style="margin-top: 20px; text-align: left;">
                <span style="font-weight:bold; font-size:11px; color:var(--subtext)">ESTIMATIONS</span>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <span id="res-wind" style="font-weight:bold; font-size:12px;">MAX WINDS: 0 MPH</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span id="res-width" style="font-weight:bold; font-size:12px;">MAX WIDTH: 0.00 MILES</span>
                </div>
            </div>
        </div>

    </div>

<script>

    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1445826838550155304/ju7TlU7iNHSgUTvh8QnhE6swgrktFYXal9ObDCHuoOvNGrlm2wTlfZFANhQFr2vtJJ4V";


    let extractedData = {};
    let lastResults = null;
    let thermoImageBlob = null;

    // --- DOM ELEMENTS ---
    const steps = {
        landing: document.getElementById('step-landing'),
        loading: document.getElementById('step-loading'),
        verify: document.getElementById('step-verify'),
        results: document.getElementById('step-results')
    };
    const pasteArea = document.getElementById('paste-area');
    const inputGrid = document.getElementById('input-grid');


    document.addEventListener('paste', handlePaste);
    
    document.getElementById('file-input').addEventListener('change', (e) => {
        if(e.target.files.length > 0) processImage(e.target.files[0]);
    });

    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let stars = [];
    let mouse = { x: -100, y: -100 };

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    resize();

    function initStars() {
        for(let i=0; i<150; i++) {
            stars.push({
                x: Math.random() * width,
                y: Math.random() * height,
                size: Math.random() * 2,
                alpha: Math.random(),
                speed: (Math.random() * 0.005 + 0.001) * (Math.random() > 0.5 ? 1 : -1)
            });
        }
    }
    initStars();

    function animate() {
        ctx.fillStyle = '#18181b';
        ctx.fillRect(0, 0, width, height);


        const grad = ctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, 150);
        grad.addColorStop(0, 'rgba(63, 63, 70, 0.3)');
        grad.addColorStop(1, 'rgba(24, 24, 27, 0)');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);


        stars.forEach(s => {
            s.alpha += s.speed;
            if(s.alpha >= 1 || s.alpha <= 0.2) s.speed *= -1;
            ctx.fillStyle = `rgba(255, 255, 255, ${s.alpha})`;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
            ctx.fill();
        });

        requestAnimationFrame(animate);
    }
    animate();


    function switchStep(stepName) {
        Object.values(steps).forEach(el => el.classList.add('hidden'));
        steps[stepName].classList.remove('hidden');
    }

    function handlePaste(e) {
        if(steps.landing.classList.contains('hidden')) return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                processImage(blob);
                return;
            }
        }
    }

    async function processImage(blob) {
        thermoImageBlob = blob;
        switchStep('loading');
        
        try {
            const { data: { text } } = await Tesseract.recognize(blob, 'eng', {
                logger: m => console.log(m)
            });
            parseData(text);
            buildVerifyUI();
            switchStep('verify');
        } catch (err) {
            alert("OCR Failed: " + err);
            switchStep('landing');
        }
    }

    function goToManual() {
        extractedData = {}; 
        buildVerifyUI();
        switchStep('verify');
    }

    function parseData(text) {

        text = text.replace(/Q/g, "0").replace(/O/g, "0").replace(/o/g, "0")
                   .replace(/@/g, "0").replace(/Ã˜/g, "0").replace(/D/g, "0")
                   .replace(/theta/g, "0");

        const find = (patterns) => {
            for (let p of patterns) {
                const regex = new RegExp(p + ".*?(\\d[\\d\\.]*)", "i");
                const match = text.match(regex);
                if (match && match[1]) return match[1].replace(/\.$/, "");
            }
            return "";
        };

        let rawPwat = find(["PWAT"]);
        // Fix pwat
        if (rawPwat.startsWith("17.")) rawPwat = "1." + rawPwat.substring(3);
        if (/^7\.\d+$/.test(rawPwat)) rawPwat = "1" + rawPwat.substring(1);
        

        let pwatVal = parseFloat(rawPwat);
        if (!isNaN(pwatVal)) {
            pwatVal = Math.round(pwatVal * 10) / 10;
            if (pwatVal > 4.0) {
                if (pwatVal === 7.0) pwatVal = 1.0;
                else if (pwatVal >= 10) pwatVal = pwatVal / 10;
                else pwatVal = 1.5;
            }
            rawPwat = pwatVal.toString();
        }

        extractedData = {
            "temp": find(["TEMPERATURE", "TEMP"]),
            "dew": find(["DEW\\s*P[O0Q@Ã˜oD]INT", "P[O0Q@Ã˜oD]INT", "DEWPOINT", "DEW"]),
            "3cape": find(["3\\s*CAPE", "3CAPE"]),
            "cape": find(["(?<!3)CAPE"]), 
            "lapse": find(["0-3\\s*[Kk]?[Mm]?\\s*LAPSE", "0-3\\s*LAPSE", "0-3"]),
            "srh": find(["SRH"]),
            "rh": find(["SURFACE\\s*RH", "SFC\\s*RH"]),
            "mid_rh": find(["MB\\s*RH", "500\\s*MB", "MID\\s*RH"]),
            "pwat": rawPwat,
            "speed": "",
            "raw": text
        };
        

        const capeMatch = text.match(/CAPE.*?(\d[\d\.]*)/i);
        if(capeMatch && capeMatch[1] && !text.match(/3\s*CAPE.*?(\d[\d\.]*)/i)) {

        }
    }

    const fields = [
        { label: "TEMP", key: "temp" }, { label: "DEW", key: "dew" },
        { label: "CAPE", key: "cape" }, { label: "3CAPE", key: "3cape" },
        { label: "SRH", key: "srh" }, { label: "LAPSE", key: "lapse" },
        { label: "SFC RH", key: "rh" }, { label: "MID RH", key: "mid_rh" },
        { label: "PWAT", key: "pwat" }, { label: "SPEED", key: "speed", placeholder: "60" },
        { label: "STP", key: "stp" }, { label: "VTP", key: "vtp" } 
    ];

    function buildVerifyUI() {
        inputGrid.innerHTML = '';
        fields.forEach(f => {
            const div = document.createElement('div');
            div.className = 'input-group';
            
            const lbl = document.createElement('label');
            lbl.innerText = f.label;
            
            const inp = document.createElement('input');
            inp.id = 'inp-' + f.key;
            inp.value = extractedData[f.key] || "";
            if(f.placeholder && !inp.value) inp.placeholder = f.placeholder;
            
            div.appendChild(lbl);
            div.appendChild(inp);
            inputGrid.appendChild(div);
        });
    }

    function calculate() {

        let v = {};
        fields.forEach(f => {
            const val = document.getElementById('inp-' + f.key).value.replace(',', '.').replace(/[^0-9.]/g, "");
            v[f.key] = parseFloat(val) || 0.0;
        });
        if(!v.speed) v.speed = 60.0;


        const norm = (val, mn, mx) => val <= mn ? 0 : val >= mx ? 1 : (val - mn) / (mx - mn);

        let energy_raw = norm(v.cape, 500, 4500) * 70 + norm(v["3cape"], 50, 200) * 30;
        let shear_raw = norm(v.srh, 100, 600) * 85 + norm(v.speed, 30, 60) * 15;

        let spread = v.temp - v.dew;
        let spread_score = (1.0 - norm(spread, 0, 15)) * 40;
        let surf_rh_score = norm(v.rh, 50, 95) * 40;
        let mid_rh_score = norm(v.mid_rh, 40, 85) * 20;
        let moisture_raw = spread_score + surf_rh_score + mid_rh_score;

        let lapse_raw = 0;
        if (v.lapse < 6.0) lapse_raw = 0;
        else if (v.lapse < 7.5) lapse_raw = norm(v.lapse, 6.0, 7.5) * 80;
        else if (v.lapse <= 8.8) lapse_raw = 100;
        else lapse_raw = 100 - (norm(v.lapse, 8.8, 10.5) * 50);

        let power_index = (energy_raw * 0.6) + (shear_raw * 0.4);

        let sh = { "Wedge": 10, "Stovepipe": 10, "Drillbit/Tiny Funnel": 3, "Sidewinder": 5, "Cone": 10, "Rope": 10 };

        if (power_index < 25) {
            sh["Cone"] += 60; sh["Rope"] += 60; sh["Drillbit/Tiny Funnel"] += 20;
            sh["Wedge"] = 5; sh["Stovepipe"] = 5;
        } else if (power_index < 50) {
            sh["Cone"] += 40; sh["Stovepipe"] += 30; sh["Rope"] += 20; sh["Wedge"] += 20;
        } else {
            if (moisture_raw > 80) {
                sh["Wedge"] += power_index * 1.2;
                if (lapse_raw > 80 && energy_raw > 80) sh["Wedge"] += 30;
            }
            let stovepipe_pts = power_index;
            if (moisture_raw < 75) { stovepipe_pts += 30; sh["Wedge"] += 25; }
            if (v.lapse > 8.5) { stovepipe_pts += 40; sh["Wedge"] += 15; }
            sh["Stovepipe"] += stovepipe_pts;

            if (v.lapse > 9.0 && moisture_raw < 60 && shear_raw > 70) sh["Drillbit/Tiny Funnel"] += 100;
            if (energy_raw < 40 && moisture_raw > 90) { sh["Drillbit/Tiny Funnel"] += 60; sh["Rope"] += 40; }
        }

        sh["Sidewinder"] += norm(v.vtp || 0, 1, 6) * 80;


        if (moisture_raw > 85 && v.lapse < 7.2) {
            sh["Sidewinder"] += 40;
            if (power_index < 75) sh["Wedge"] -= 20;
        }


        if (sh["Wedge"] > 50 && ((v.vtp || 0) > 2.5 || v.speed > 55)) {
            sh["Sidewinder"] += 40;
        }


        if (v.speed > 70) sh["Sidewinder"] += (v.speed - 70) * 5;


        if (power_index < 60 && v.lapse > 8.5) {
            sh["Sidewinder"] += 30; sh["Cone"] -= 10;
        }


        if (power_index > 75) {
            if (v.lapse >= 7.5 && v.lapse <= 8.5) {
                sh["Wedge"] += 40; sh["Stovepipe"] += 30;
                if (moisture_raw > 85) sh["Wedge"] += 40;
                else if (moisture_raw > 60) sh["Stovepipe"] += 20;
            } else if (v.lapse > 8.5) {
                sh["Stovepipe"] += 10; sh["Wedge"] -= 7;
            }
        }

        if (v.lapse > 10.0) { sh["Wedge"] *= 0.2; sh["Drillbit/Tiny Funnel"] += 40; }

        let mv = Math.min(95, 5 + norm(v.srh, 200, 800) * 80 + norm(v.stp || 0, 5, 25) * 20);
        let rain = Math.min(100, 10 + norm(v.pwat, 1.0, 2.5) * 70 + norm(v.rh, 60, 100) * 20);

        let constriction_bonus = norm(v.lapse, 7.0, 10.0) * 2.0;
        let ef_score = (v.cape * v.srh) / 150000 + constriction_bonus;

        let ef = "EF0";
        if (ef_score > 1.5) ef = "EF1";
        if (ef_score > 3.0) ef = "EF2";
        if (ef_score > 5.0) ef = "EF3";
        if (ef_score > 8.0) ef = "EF4";
        if (ef_score > 13.0) ef = "EF5";

        let est_wind = 65 + (ef_score * 11);
        if (est_wind > 320) est_wind = 320;

        let dominant = Object.keys(sh).reduce((a, b) => sh[a] > sh[b] ? a : b);
        let base_width = power_index * 12;
        let width_mult = 1.0;
        if (dominant === "Wedge") width_mult = 2.2;
        else if (dominant === "Sidewinder") width_mult = 1.4;
        else if (dominant === "Stovepipe") width_mult = 1.0;
        else if (dominant === "Cone") width_mult = 0.5;
        else if (dominant === "Rope") width_mult = 0.2;
        else if (dominant.includes("Drillbit")) width_mult = 0.4;

        let est_width = base_width * width_mult;
        if (est_width < 50) est_width = 50;
        let width_miles = est_width / 1760.0;


        lastResults = {
            inputs: v,
            ef: ef,
            wind: Math.floor(est_wind),
            width: width_miles.toFixed(2),
            shape_scores: sh
        };

        showResults(sh, mv, rain, ef, est_wind, width_miles);
    }

    function showResults(sh, mv, rain, ef, wind, width) {
        switchStep('results');
        
        document.getElementById('res-ef').innerText = ef;
        document.getElementById('res-wind').innerText = `MAX WINDS: ${Math.floor(wind)} MPH`;
        document.getElementById('res-width').innerText = `MAX WIDTH: ${width.toFixed(2)} MILES`;

        const colors = {
            "Wedge":"#f38ba8", "Stovepipe":"#89b4fa", "Drillbit/Tiny Funnel":"#94e2d5",
            "Sidewinder":"#a6e3a1", "Cone":"#cba6f7", "Rope":"#6c7086"
        };

        let total = Object.values(sh).reduce((a,b)=>a+b, 0);
        let sorted = Object.entries(sh).sort((a,b)=>b[1]-a[1]);
        
        let html = '';
        sorted.forEach(([key, val]) => {
            let pct = (val / total) * 100;
            html += `
            <div class="bar-container">
                <div class="bar-header">
                    <span>${key.toUpperCase()}</span>
                    <span>${pct.toFixed(1)}%</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width:${pct}%; background:${colors[key]||'white'};"></div>
                </div>
            </div>`;
        });


        [ ["MULTI-VORTEX", mv, "#fab387"], ["RAIN WRAPPED", rain, "#f9e2af"] ].forEach(([name, val, col]) => {
            html += `
            <div class="bar-container" style="margin-top:20px;">
                <div class="bar-header">
                    <span>${name}</span>
                    <span>${val.toFixed(1)}%</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width:${val}%; background:${col};"></div>
                </div>
            </div>`;
        });

        document.getElementById('res-bars').innerHTML = html;
        

        setTimeout(() => {

        }, 10);
    }

    function resetApp() {
        extractedData = {};
        lastResults = null;
        switchStep('landing');
        document.getElementById('file-input').value = '';
    }

    function reportBug(useLastResults=false) {
        const msg = prompt("Describe the error or issue:");
        if (!msg) return;

        let payload = {
            embeds: [{
                title: "VORTEX WEB Bug Report",
                description: `**User Feedback:**\n> ${msg}\n\n`,
                color: 16777215
            }]
        };

        if (useLastResults && lastResults) {
            payload.embeds[0].description += "**Calculation Data:**\n```json\n" + JSON.stringify(lastResults, null, 2) + "\n```";
        } else {
            payload.embeds[0].description += "**Raw OCR Data:**\n```\n" + (extractedData.raw || "Manual Entry") + "\n```";
        }

        const formData = new FormData();
        formData.append('payload_json', JSON.stringify(payload));
        if (thermoImageBlob) {
            formData.append('file', thermoImageBlob, 'thermo.png');
        }

        fetch(DISCORD_WEBHOOK, {
            method: 'POST',
            body: formData
        }).then(response => {
            if(response.ok) alert("Report Sent!");
            else alert("Failed to send report.");
        }).catch(err => alert("Error: " + err));
    }

</script>
</body>
</html>
